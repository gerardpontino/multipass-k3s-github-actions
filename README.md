# Multipass K3s Cluster Provisioning with GitHub Actions

This repository provides an **Ansible playbook** and **GitHub Actions workflow** to automatically provision a **lightweight K3s Kubernetes cluster** using **Multipass VMs**. The workflow supports **dynamic scaling** of worker nodes.

---

## Features

- Provision **one master node** and a configurable number of **worker nodes**.
- Install **K3s** on master and worker nodes automatically.
- Retrieve the **Kubeconfig** for local usage.
- Fully **automated via GitHub Actions**, using a **self-hosted runner**.
- Supports **dynamic scaling** of worker nodes with workflow input.

---

## Prerequisites

- macOS machine with **Multipass** installed.
- **Ansible** installed.
- **GitHub CLI (`gh`)** for manual workflow triggers.
- **Self-hosted runner** registered on your Mac (if using GitHub Actions).

---

## Usage

### 1. Pull the repository

Clone the repository locally (optional for triggering workflow, required for local testing):

```bash
git clone https://github.com/<your-org>/<your-repo>.git
cd <your-repo>
```

### 2. Trigger workflow from GitHub web
Go to Actions → [Workflow Name] → Run workflow.

Set the number of worker nodes to provision.

Click Run workflow.

### 3. Trigger workflow from another machine using GitHub CLI
```bash
gh workflow run cluster-provision.yml \
  --repo <your-org>/<your-repo> \
  --field worker_count=2
```
Notes:

The workflow will execute on the self-hosted runner (your MacBook) and provision VMs locally.

No local copy of the workflow is needed on the triggering machine.

Logs and status are available in the GitHub Actions UI.

### 4. Test locally (optional)

If you want to run the Ansible playbook directly on your Mac:
```bash
ansible-playbook -i inventory.yml dynamic_k3s_provisioning.yaml -e "worker_count=2"
```
Notes:

Ensure you’ve pulled the repository locally first.

Adjust the worker_count value to scale the number of worker nodes.

This allows you to quickly test changes without running through GitHub Actions.

### 5. Verify K3s Cluster
After provisioning, you can verify that nodes have joined the cluster:
```bash
kubectl get nodes
```

This will show the master node and all worker nodes.
Use the ~/.kube/config file generated by the playbook for kubectl access.

### Repository Structure
```bash
.github/workflows/            # GitHub Actions workflow file
dynamic_k3s_provisioning.yaml # Ansible playbook
inventory.yml                 # Ansible inventory file
README.md                     # This documentation
```
### Notes

Multipass VMs are created on the self-hosted runner machine.

The worker_count input allows you to scale worker nodes dynamically.

GitHub Actions automatically checks out the repo, so other machines can trigger workflows without having local files.

Workflow logs and status are available in the GitHub Actions UI.





