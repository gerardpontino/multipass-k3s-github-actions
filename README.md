# Multipass K3s Cluster Provisioning with GitHub Actions

This repository provides an **Ansible playbook** and **GitHub Actions workflow** to automatically provision a **lightweight K3s Kubernetes cluster** using **Multipass VMs**. The workflow supports **dynamic scaling** of worker nodes.

---

## Features

- Provision **one master node** and a configurable number of **worker nodes**.
- Install **K3s** on master and worker nodes automatically.
- Retrieve the **Kubeconfig** for local usage.
- Fully **automated via GitHub Actions**, using a **self-hosted runner**.
- Supports **dynamic scaling** of worker nodes with workflow input.

---

## Prerequisites

- macOS machine with **Multipass** installed.
- **Ansible** installed.
- **GitHub CLI (`gh`)** for manual workflow triggers.
- **Self-hosted runner** registered on your Mac (if using GitHub Actions).

---

## Setting Up a GitHub Actions Self-Hosted Runner on macOS

1. Go to your repository on GitHub → **Settings → Actions → Runners → Add Runner**.
2. Select **macOS** as the runner OS.
3. Download the runner package and extract it:

```bash
mkdir actions-runner && cd actions-runner
curl -O -L https://github.com/actions/runner/releases/download/v2.329.0/actions-runner-osx-x64-2.329.0.tar.gz
tar xzf ./actions-runner-osx-x64-2.329.0.tar.gz
```
### 4. Configure the runner with your repository:
```bash
./config.sh --url https://github.com/<your-org>/<your-repo> --token <generated-token>
```
### 5. Start the runner.
```bash
./run.sh
```
The runner will now listen for jobs from your repository.

Leave this terminal open or run it as a background service to keep the runner active.


## Usage

### 1. Pull the repository

Clone the repository locally (optional for triggering workflow, required for local testing):

```bash
git clone https://github.com/gerardpontino/multipass-k3s-github-actions.git
cd multipass-k3s-github-actions
```
> **Note:** After cloning your own repository, you can move or copy these files into it to customize, run, or manage workflows there. This step assumes you have already **pushed the workflow, playbook, and inventory files to your repository**.

### 2. (Optional) Trigger workflow from GitHub web

If you want to test the workflow via the GitHub web interface:

1. Go to **Actions → [Workflow Name] → Run workflow**.
2. Set the **number of worker nodes** to provision.
3. Click **Run workflow**.

> **Note:** This step is optional if you prefer triggering the workflow via GitHub CLI or running locally.


### 3. Trigger workflow from another machine using GitHub CLI
```bash
gh workflow run cluster-provision.yml \
  --repo https://github.com/gerardpontino/multipass-k3s-github-actions.git \
  --field worker_count=2
```
Notes:

The workflow will execute on the self-hosted runner (your MacBook) and provision VMs locally.

No local copy of the workflow is needed on the triggering machine.

Logs and status are available in the GitHub Actions UI.

### 4. Test locally (optional)

If you want to run the Ansible playbook directly on your Mac:
```bash
ansible-playbook -i inventory.yml dynamic_k3s_provisioning.yaml -e "worker_count=2"
```
Notes:

Ensure you’ve pulled the repository locally first.

Adjust the worker_count value to scale the number of worker nodes.

This allows you to quickly test changes without running through GitHub Actions.

### 5. Verify K3s Cluster
After provisioning, you can verify that nodes have joined the cluster:
```bash
kubectl get nodes
```

This will show the master node and all worker nodes.
Use the ~/.kube/config file generated by the playbook for kubectl access.

### Repository Structure
```bash
.github/workflows/            # GitHub Actions workflow file
dynamic_k3s_provisioning.yaml # Ansible playbook
inventory.yml                 # Ansible inventory file
README.md                     # This documentation
```
### Notes

Multipass VMs are created on the self-hosted runner machine.

The worker_count input allows you to scale worker nodes dynamically.

GitHub Actions automatically checks out the repo, so other machines can trigger workflows without having local files.

Workflow logs and status are available in the GitHub Actions UI.





